<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>server/protocol/base.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="HttpClientFactory.html">HttpClientFactory</a><ul class='methods'><li data-type='method'><a href="HttpClientFactory.html#batch">batch</a></li><li data-type='method'><a href="HttpClientFactory.html#cleanUp">cleanUp</a></li><li data-type='method'><a href="HttpClientFactory.html#connect">connect</a></li><li data-type='method'><a href="HttpClientFactory.html#end">end</a></li><li data-type='method'><a href="HttpClientFactory.html#request">request</a></li><li data-type='method'><a href="HttpClientFactory.html#serverDisconnected">serverDisconnected</a></li><li data-type='method'><a href="HttpClientFactory.html#subscribe">subscribe</a></li><li data-type='method'><a href="HttpClientFactory.html#unsubscribe">unsubscribe</a></li><li data-type='method'><a href="HttpClientFactory.html#unsubscribeAll">unsubscribeAll</a></li></ul></li><li><a href="HttpClientProtocol.html">HttpClientProtocol</a><ul class='methods'><li data-type='method'><a href="HttpClientProtocol.html#batch">batch</a></li><li data-type='method'><a href="HttpClientProtocol.html#connect">connect</a></li><li data-type='method'><a href="HttpClientProtocol.html#end">end</a></li><li data-type='method'><a href="HttpClientProtocol.html#getBatchResponse">getBatchResponse</a></li><li data-type='method'><a href="HttpClientProtocol.html#getResponse">getResponse</a></li><li data-type='method'><a href="HttpClientProtocol.html#gotBatchResponse">gotBatchResponse</a></li><li data-type='method'><a href="HttpClientProtocol.html#handleBatch">handleBatch</a></li><li data-type='method'><a href="HttpClientProtocol.html#handleError">handleError</a></li><li data-type='method'><a href="HttpClientProtocol.html#handleNotification">handleNotification</a></li><li data-type='method'><a href="HttpClientProtocol.html#handleResponse">handleResponse</a></li><li data-type='method'><a href="HttpClientProtocol.html#listen">listen</a></li><li data-type='method'><a href="HttpClientProtocol.html#message">message</a></li><li data-type='method'><a href="HttpClientProtocol.html#notify">notify</a></li><li data-type='method'><a href="HttpClientProtocol.html#rejectPendingCalls">rejectPendingCalls</a></li><li data-type='method'><a href="HttpClientProtocol.html#request">request</a></li><li data-type='method'><a href="HttpClientProtocol.html#send">send</a></li><li data-type='method'><a href="HttpClientProtocol.html#setConnector">setConnector</a></li><li data-type='method'><a href="HttpClientProtocol.html#verifyData">verifyData</a></li><li data-type='method'><a href="HttpClientProtocol.html#write">write</a></li></ul></li><li><a href="HttpServerFactory.html">HttpServerFactory</a><ul class='methods'><li data-type='method'><a href="HttpServerFactory.html#buildProtocol">buildProtocol</a></li><li data-type='method'><a href="HttpServerFactory.html#close">close</a></li><li data-type='method'><a href="HttpServerFactory.html#listen">listen</a></li><li data-type='method'><a href="HttpServerFactory.html#setServer">setServer</a></li><li data-type='method'><a href="HttpServerFactory.html#setupListeners">setupListeners</a></li></ul></li><li><a href="HttpServerProtocol.html">HttpServerProtocol</a><ul class='methods'><li data-type='method'><a href="HttpServerProtocol.html#clientConnected">clientConnected</a></li><li data-type='method'><a href="HttpServerProtocol.html#getResult">getResult</a></li><li data-type='method'><a href="HttpServerProtocol.html#handleBatchRequest">handleBatchRequest</a></li><li data-type='method'><a href="HttpServerProtocol.html#handleError">handleError</a></li><li data-type='method'><a href="HttpServerProtocol.html#handleNotification">handleNotification</a></li><li data-type='method'><a href="HttpServerProtocol.html#handleRequest">handleRequest</a></li><li data-type='method'><a href="HttpServerProtocol.html#validateMessage">validateMessage</a></li><li data-type='method'><a href="HttpServerProtocol.html#validateRequest">validateRequest</a></li><li data-type='method'><a href="HttpServerProtocol.html#writeToClient">writeToClient</a></li></ul></li><li><a href="JsonRpcClientFactory.html">JsonRpcClientFactory</a><ul class='methods'><li data-type='method'><a href="JsonRpcClientFactory.html#batch">batch</a></li><li data-type='method'><a href="JsonRpcClientFactory.html#cleanUp">cleanUp</a></li><li data-type='method'><a href="JsonRpcClientFactory.html#connect">connect</a></li><li data-type='method'><a href="JsonRpcClientFactory.html#end">end</a></li><li data-type='method'><a href="JsonRpcClientFactory.html#request">request</a></li><li data-type='method'><a href="JsonRpcClientFactory.html#serverDisconnected">serverDisconnected</a></li><li data-type='method'><a href="JsonRpcClientFactory.html#subscribe">subscribe</a></li><li data-type='method'><a href="JsonRpcClientFactory.html#unsubscribe">unsubscribe</a></li><li data-type='method'><a href="JsonRpcClientFactory.html#unsubscribeAll">unsubscribeAll</a></li></ul></li><li><a href="JsonRpcClientProtocol.html">JsonRpcClientProtocol</a><ul class='methods'><li data-type='method'><a href="JsonRpcClientProtocol.html#batch">batch</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#connect">connect</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#end">end</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#getBatchResponse">getBatchResponse</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#getResponse">getResponse</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#gotBatchResponse">gotBatchResponse</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#handleBatch">handleBatch</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#handleError">handleError</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#handleNotification">handleNotification</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#handleResponse">handleResponse</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#listen">listen</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#message">message</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#notify">notify</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#rejectPendingCalls">rejectPendingCalls</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#request">request</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#send">send</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#setConnector">setConnector</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#verifyData">verifyData</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#write">write</a></li></ul></li><li><a href="JsonRpcServerFactory.html">JsonRpcServerFactory</a><ul class='methods'><li data-type='method'><a href="JsonRpcServerFactory.html#buildProtocol">buildProtocol</a></li><li data-type='method'><a href="JsonRpcServerFactory.html#close">close</a></li><li data-type='method'><a href="JsonRpcServerFactory.html#listen">listen</a></li><li data-type='method'><a href="JsonRpcServerFactory.html#setServer">setServer</a></li><li data-type='method'><a href="JsonRpcServerFactory.html#setupListeners">setupListeners</a></li></ul></li><li></li><li><a href="JsonRpcServerProtocol.html">JsonRpcServerProtocol</a><ul class='methods'><li data-type='method'><a href="JsonRpcServerProtocol.html#clientConnected">clientConnected</a></li><li data-type='method'><a href="JsonRpcServerProtocol.html#getResult">getResult</a></li><li data-type='method'><a href="JsonRpcServerProtocol.html#handleBatchRequest">handleBatchRequest</a></li><li data-type='method'><a href="JsonRpcServerProtocol.html#handleError">handleError</a></li><li data-type='method'><a href="JsonRpcServerProtocol.html#handleNotification">handleNotification</a></li><li data-type='method'><a href="JsonRpcServerProtocol.html#handleRequest">handleRequest</a></li><li data-type='method'><a href="JsonRpcServerProtocol.html#validateMessage">validateMessage</a></li><li data-type='method'><a href="JsonRpcServerProtocol.html#validateRequest">validateRequest</a></li><li data-type='method'><a href="JsonRpcServerProtocol.html#writeToClient">writeToClient</a></li></ul></li><li><a href="MessageBuffer.html">MessageBuffer</a><ul class='methods'><li data-type='method'><a href="MessageBuffer.html#getMessage">getMessage</a></li><li data-type='method'><a href="MessageBuffer.html#handleData">handleData</a></li><li data-type='method'><a href="MessageBuffer.html#isFinished">isFinished</a></li><li data-type='method'><a href="MessageBuffer.html#push">push</a></li></ul></li><li><a href="TcpClientFactory.html">TcpClientFactory</a><ul class='methods'><li data-type='method'><a href="TcpClientFactory.html#batch">batch</a></li><li data-type='method'><a href="TcpClientFactory.html#cleanUp">cleanUp</a></li><li data-type='method'><a href="TcpClientFactory.html#connect">connect</a></li><li data-type='method'><a href="TcpClientFactory.html#end">end</a></li><li data-type='method'><a href="TcpClientFactory.html#request">request</a></li><li data-type='method'><a href="TcpClientFactory.html#serverDisconnected">serverDisconnected</a></li><li data-type='method'><a href="TcpClientFactory.html#subscribe">subscribe</a></li><li data-type='method'><a href="TcpClientFactory.html#unsubscribe">unsubscribe</a></li><li data-type='method'><a href="TcpClientFactory.html#unsubscribeAll">unsubscribeAll</a></li></ul></li><li><a href="TcpClientProtocol.html">TcpClientProtocol</a><ul class='methods'><li data-type='method'><a href="TcpClientProtocol.html#batch">batch</a></li><li data-type='method'><a href="TcpClientProtocol.html#connect">connect</a></li><li data-type='method'><a href="TcpClientProtocol.html#end">end</a></li><li data-type='method'><a href="TcpClientProtocol.html#getBatchResponse">getBatchResponse</a></li><li data-type='method'><a href="TcpClientProtocol.html#getResponse">getResponse</a></li><li data-type='method'><a href="TcpClientProtocol.html#gotBatchResponse">gotBatchResponse</a></li><li data-type='method'><a href="TcpClientProtocol.html#handleBatch">handleBatch</a></li><li data-type='method'><a href="TcpClientProtocol.html#handleError">handleError</a></li><li data-type='method'><a href="TcpClientProtocol.html#handleNotification">handleNotification</a></li><li data-type='method'><a href="TcpClientProtocol.html#handleResponse">handleResponse</a></li><li data-type='method'><a href="TcpClientProtocol.html#listen">listen</a></li><li data-type='method'><a href="TcpClientProtocol.html#message">message</a></li><li data-type='method'><a href="TcpClientProtocol.html#notify">notify</a></li><li data-type='method'><a href="TcpClientProtocol.html#rejectPendingCalls">rejectPendingCalls</a></li><li data-type='method'><a href="TcpClientProtocol.html#request">request</a></li><li data-type='method'><a href="TcpClientProtocol.html#send">send</a></li><li data-type='method'><a href="TcpClientProtocol.html#setConnector">setConnector</a></li><li data-type='method'><a href="TcpClientProtocol.html#verifyData">verifyData</a></li><li data-type='method'><a href="TcpClientProtocol.html#write">write</a></li></ul></li><li><a href="TcpServerFactory.html">TcpServerFactory</a><ul class='methods'><li data-type='method'><a href="TcpServerFactory.html#buildProtocol">buildProtocol</a></li><li data-type='method'><a href="TcpServerFactory.html#close">close</a></li><li data-type='method'><a href="TcpServerFactory.html#listen">listen</a></li><li data-type='method'><a href="TcpServerFactory.html#sendNotification">sendNotification</a></li><li data-type='method'><a href="TcpServerFactory.html#setServer">setServer</a></li><li data-type='method'><a href="TcpServerFactory.html#setupListeners">setupListeners</a></li></ul></li><li><a href="TcpServerProtocol.html">TcpServerProtocol</a><ul class='methods'><li data-type='method'><a href="TcpServerProtocol.html#clientConnected">clientConnected</a></li><li data-type='method'><a href="TcpServerProtocol.html#getResult">getResult</a></li><li data-type='method'><a href="TcpServerProtocol.html#handleBatchRequest">handleBatchRequest</a></li><li data-type='method'><a href="TcpServerProtocol.html#handleError">handleError</a></li><li data-type='method'><a href="TcpServerProtocol.html#handleNotification">handleNotification</a></li><li data-type='method'><a href="TcpServerProtocol.html#handleRequest">handleRequest</a></li><li data-type='method'><a href="TcpServerProtocol.html#validateMessage">validateMessage</a></li><li data-type='method'><a href="TcpServerProtocol.html#validateRequest">validateRequest</a></li><li data-type='method'><a href="TcpServerProtocol.html#writeToClient">writeToClient</a></li></ul></li><li><a href="WsBrowserClientFactory.html">WsBrowserClientFactory</a><ul class='methods'><li data-type='method'><a href="WsBrowserClientFactory.html#batch">batch</a></li><li data-type='method'><a href="WsBrowserClientFactory.html#cleanUp">cleanUp</a></li><li data-type='method'><a href="WsBrowserClientFactory.html#connect">connect</a></li><li data-type='method'><a href="WsBrowserClientFactory.html#end">end</a></li><li data-type='method'><a href="WsBrowserClientFactory.html#request">request</a></li><li data-type='method'><a href="WsBrowserClientFactory.html#subscribe">subscribe</a></li><li data-type='method'><a href="WsBrowserClientFactory.html#unsubscribe">unsubscribe</a></li><li data-type='method'><a href="WsBrowserClientFactory.html#unsubscribeAll">unsubscribeAll</a></li></ul></li><li><a href="WsBrowserClientProtocol.html">WsBrowserClientProtocol</a><ul class='methods'><li data-type='method'><a href="WsBrowserClientProtocol.html#batch">batch</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#getBatchResponse">getBatchResponse</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#getResponse">getResponse</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#gotBatchResponse">gotBatchResponse</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#handleBatch">handleBatch</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#handleError">handleError</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#handleNotification">handleNotification</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#handleResponse">handleResponse</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#message">message</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#notify">notify</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#rejectPendingCalls">rejectPendingCalls</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#request">request</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#send">send</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#setConnector">setConnector</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#verifyData">verifyData</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#write">write</a></li></ul></li><li><a href="WsClientFactory.html">WsClientFactory</a><ul class='methods'><li data-type='method'><a href="WsClientFactory.html#batch">batch</a></li><li data-type='method'><a href="WsClientFactory.html#cleanUp">cleanUp</a></li><li data-type='method'><a href="WsClientFactory.html#connect">connect</a></li><li data-type='method'><a href="WsClientFactory.html#end">end</a></li><li data-type='method'><a href="WsClientFactory.html#request">request</a></li><li data-type='method'><a href="WsClientFactory.html#serverDisconnected">serverDisconnected</a></li><li data-type='method'><a href="WsClientFactory.html#subscribe">subscribe</a></li><li data-type='method'><a href="WsClientFactory.html#unsubscribe">unsubscribe</a></li><li data-type='method'><a href="WsClientFactory.html#unsubscribeAll">unsubscribeAll</a></li></ul></li><li><a href="WsClientProtocol.html">WsClientProtocol</a><ul class='methods'><li data-type='method'><a href="WsClientProtocol.html#batch">batch</a></li><li data-type='method'><a href="WsClientProtocol.html#connect">connect</a></li><li data-type='method'><a href="WsClientProtocol.html#end">end</a></li><li data-type='method'><a href="WsClientProtocol.html#getBatchResponse">getBatchResponse</a></li><li data-type='method'><a href="WsClientProtocol.html#getResponse">getResponse</a></li><li data-type='method'><a href="WsClientProtocol.html#gotBatchResponse">gotBatchResponse</a></li><li data-type='method'><a href="WsClientProtocol.html#handleBatch">handleBatch</a></li><li data-type='method'><a href="WsClientProtocol.html#handleError">handleError</a></li><li data-type='method'><a href="WsClientProtocol.html#handleNotification">handleNotification</a></li><li data-type='method'><a href="WsClientProtocol.html#handleResponse">handleResponse</a></li><li data-type='method'><a href="WsClientProtocol.html#listen">listen</a></li><li data-type='method'><a href="WsClientProtocol.html#message">message</a></li><li data-type='method'><a href="WsClientProtocol.html#notify">notify</a></li><li data-type='method'><a href="WsClientProtocol.html#rejectPendingCalls">rejectPendingCalls</a></li><li data-type='method'><a href="WsClientProtocol.html#request">request</a></li><li data-type='method'><a href="WsClientProtocol.html#send">send</a></li><li data-type='method'><a href="WsClientProtocol.html#setConnector">setConnector</a></li><li data-type='method'><a href="WsClientProtocol.html#verifyData">verifyData</a></li><li data-type='method'><a href="WsClientProtocol.html#write">write</a></li></ul></li><li><a href="WsServerFactory.html">WsServerFactory</a><ul class='methods'><li data-type='method'><a href="WsServerFactory.html#buildProtocol">buildProtocol</a></li><li data-type='method'><a href="WsServerFactory.html#close">close</a></li><li data-type='method'><a href="WsServerFactory.html#listen">listen</a></li><li data-type='method'><a href="WsServerFactory.html#sendNotification">sendNotification</a></li><li data-type='method'><a href="WsServerFactory.html#setServer">setServer</a></li><li data-type='method'><a href="WsServerFactory.html#setSever">setSever</a></li><li data-type='method'><a href="WsServerFactory.html#setupListeners">setupListeners</a></li></ul></li><li><a href="WsServerProtocol.html">WsServerProtocol</a><ul class='methods'><li data-type='method'><a href="WsServerProtocol.html#clientConnected">clientConnected</a></li><li data-type='method'><a href="WsServerProtocol.html#getResult">getResult</a></li><li data-type='method'><a href="WsServerProtocol.html#handleBatchRequest">handleBatchRequest</a></li><li data-type='method'><a href="WsServerProtocol.html#handleError">handleError</a></li><li data-type='method'><a href="WsServerProtocol.html#handleNotification">handleNotification</a></li><li data-type='method'><a href="WsServerProtocol.html#handleRequest">handleRequest</a></li><li data-type='method'><a href="WsServerProtocol.html#validateMessage">validateMessage</a></li><li data-type='method'><a href="WsServerProtocol.html#validateRequest">validateRequest</a></li><li data-type='method'><a href="WsServerProtocol.html#writeToClient">writeToClient</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="Jaysonic.html">Jaysonic</a></li></ul><h3>Global</h3><ul><li><a href="global.html#formatError">formatError</a></li><li><a href="global.html#formatRequest">formatRequest</a></li><li><a href="global.html#formatResponse">formatResponse</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">server/protocol/base.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const { MessageBuffer } = require("../../buffer");
const { formatResponse, formatError } = require("../../functions");
const { ERR_CODES, ERR_MSGS } = require("../../constants");

/**
 * Creates an instance of JsonRpcServerProtocol. This is the
 * base protocol from which all others inherit.
 *
 */
class JsonRpcServerProtocol {
  /**
   * @param {class} factory Instance of [JsonRpcServerFactory]{@link JsonRpcServerFactory}
   * @param {class} client Instance of `net.Socket`
   * @param {string|number} version JSON-RPC version to use
   * @param {string} delimiter Delimiter to use for `messageBuffer`
   * @property {class} messageBuffer Instance of [MessageBuffer]{@link MessageBuffer}
   * @property {string} event="data" The event name to listen for incoming data
   */
  constructor(factory, client, version, delimiter) {
    this.client = client;
    this.factory = factory;
    this.delimiter = delimiter;
    this.version = version;
    this.messageBuffer = new MessageBuffer(delimiter);
    this.event = "data";
  }

  /**
   * Registers the `event` listener when client connects.
   *
   * Pushes received data into `messageBuffer` and calls
   * [_waitForData]{@link JsonRpcServerProtocol#_waitForData}.
   *
   * Registers `end` event to emit a `clientDisconnected` event
   * on the factory
   *
   */
  clientConnected() {
    this.client.on(this.event, (data) => {
      this.messageBuffer.push(data);
      this._waitForData();
    });
    this.client.on("end", () => {
      this.factory.emit("clientDisconnected", this.client);
    });
  }

  /**
   * Accumulate data while [MessageBuffer.isFinished]{@link MessageBuffer#isFinished} is returning false.
   *
   * If the buffer returns a message it will be passed to [validateRequest]{@link JsonRpcServerProtocol#validateRequest}.
   * If [validateRequest]{@link JsonRpcServerProtocol#validateRequest} returns a parsed result, then the result
   * is passed to [_maybeHandleRequest]{@link JsonRpcServerProtocol#_maybeHandleRequest}.
   * If [_maybeHandleRequest]{@link JsonRpcServerProtocol#_maybeHandleRequest} returns true, then
   * [handleRequest]{@link JsonRpcServerProtocol#handleRequest} is called.&lt;br/>&lt;br/>
   *
   * If any of the above throws an error, [handleError]{@link JsonRpcServerProtocol#handleError} is called.
   *
   * @private
   *
   */
  _waitForData() {
    while (!this.messageBuffer.isFinished()) {
      const chunk = this.messageBuffer.handleData();
      try {
        const result = this.validateRequest(chunk);
        const isMessage = this._maybeHandleRequest(result);
        if (isMessage) {
          this.handleRequest(result);
        }
      } catch (e) {
        this.handleError(e);
      }
    }
  }

  /**
   * Validate the incoming data returned from `messageBuffer`
   *
   * @param {string} chunk
   * @return {JSON}
   * @throws Will throw an error with a JSON-RPC error object if chunk cannot be parsed
   */
  validateRequest(chunk) {
    try {
      return JSON.parse(chunk);
    } catch (e) {
      throw new Error(
        formatError({
          jsonrpc: this.version,
          id: null,
          code: ERR_CODES.parseError,
          message: ERR_MSGS.parseError,
          delimiter: this.delimiter
        })
      );
    }
  }

  /**
   * Determines the type of request being made (batch, notification, request) and
   * calls the corresponding function.
   *
   * @param {JSON} result Valid JSON-RPC request object
   * @private
   */
  _maybeHandleRequest(result) {
    if (Array.isArray(result)) {
      if (result.length === 0) {
        return this.writeToClient(
          formatError({
            code: ERR_CODES.invalidRequest,
            message: ERR_MSGS.invalidRequest,
            delimiter: this.delimiter,
            jsonrpc: this.version,
            id: null
          })
        );
      }
      // possible batch request
      this.handleBatchRequest(result).then((res) => {
        this.writeToClient(JSON.stringify(res) + this.delimiter);
      });
    } else if (result === Object(result) &amp;&amp; !("id" in result)) {
      // no id, so assume notification
      this.handleNotification(result);
    } else {
      this.validateMessage(result);
      return true;
    }
  }

  /**
   * Validates if there are any issues with the incoming request&lt;br/>
   *
   *
   * @param {JSON} message Valid JSON-RPC request object
   * @throws Will throw an error for any of the below reasons
   *
   * Reason|Type
   * ---|---
   * message is not an object| Invalid Request
   * the server does not have the required method| Method Not Found
   * the params are not an array or object| Invalid Params
   * the "jsonrpc" property was passed for a v1 server| Invalid Request
   */
  validateMessage(message) {
    if (!(message === Object(message))) {
      this._raiseError(ERR_MSGS.invalidRequest, ERR_CODES.invalidRequest, null);
    } else if (!(typeof message.method === "string")) {
      this._raiseError(
        ERR_MSGS.invalidRequest,
        ERR_CODES.invalidRequest,
        message.id
      );
    } else if (!(message.method in this.factory.methods)) {
      this._raiseError(
        ERR_MSGS.methodNotFound,
        ERR_CODES.methodNotFound,
        message.id
      );
    } else if (
      message.params &amp;&amp;
      !Array.isArray(message.params) &amp;&amp;
      !(message.params === Object(message.params))
    ) {
      this._raiseError(
        ERR_MSGS.invalidParams,
        ERR_CODES.invalidParams,
        message.id
      );
    } else if (message.jsonrpc &amp;&amp; this.version !== "2.0") {
      this._raiseError(
        ERR_MSGS.invalidRequest,
        ERR_CODES.invalidRequest,
        message.id
      );
    }
  }

  /**
   * Send message to the client
   *
   * @param {string} message Stringified JSON-RPC message object
   */
  writeToClient(message) {
    this.client.write(message);
  }

  /**
   * Calls `emit` on factory with the event name being `message.method` and
   * the date being `message`.
   *
   * @param {string} message Stringified JSON-RPC message object
   */
  handleNotification(message) {
    this.factory.emit(message.method, message);
  }

  /**
   * Attempts to get the result for the request object. Will
   * send result to client if successful and will send an error
   * otherwise.
   *
   * @param {JSON} message JSON-RPC message object
   * @returns {Promise}
   */
  handleRequest(message) {
    return this.getResult(message)
      .then((result) => {
        this.writeToClient(result);
      })
      .catch((error) => {
        this.handleError(Error(error));
      });
  }

  /**
   * Attempts to get the result for all requests in the batch.
   * Will send result to client if successful and error otherwise.
   *
   * @param {JSON[]} requests Valid JSON-RPC batch request
   * @returns {Promise[]}
   */
  handleBatchRequest(requests) {
    const batchResponses = requests
      .map((request) => {
        try {
          this._maybeHandleRequest(request);
          return this.getResult(request)
            .then((result) => JSON.parse(result))
            .catch((error) => JSON.parse(error));
        } catch (e) {
          // basically reject the whole batch if any one thing fails
          return JSON.parse(e.message);
        }
      })
      .filter((el) => el != null);
    return Promise.all(batchResponses);
  }

  /**
   * Get the result for the request. Calls the function associated
   * with the method and returns the result.
   *
   * @param {JSON} message Valid JSON-RPC message object
   * @returns {Promise}
   */
  getResult(message) {
    // function needs to be async since the method can be a promise
    return new Promise((resolve, reject) => {
      const { params } = message;
      const response = {
        jsonrpc: message.jsonrpc,
        id: message.id,
        delimiter: this.delimiter
      };
      const error = {
        jsonrpc: message.jsonrpc,
        id: message.id,
        delimiter: this.delimiter
      };
      try {
        const result = params
          ? this.factory.methods[message.method](params)
          : this.factory.methods[message.method]();
        if (result instanceof Promise || typeof result.then === "function") {
          Promise.all([result])
            .then((results) => {
              response.result = results || 0;
              resolve(formatResponse(response));
            })
            .catch((resError) => {
              error.code = ERR_CODES.internal;
              error.message = `${JSON.stringify(resError.message || resError)}`;
              reject(formatError(error));
            });
        } else {
          response.result = result || 0;
          resolve(formatResponse(response));
        }
      } catch (e) {
        if (e instanceof TypeError) {
          error.code = ERR_CODES.invalidParams;
          error.message = ERR_MSGS.invalidParams;
        } else {
          error.code = ERR_CODES.unknown;
          error.message = ERR_MSGS.unknown;
        }
        reject(formatError(error));
      }
    });
  }
  /**
   *
   * @param {string} message Error message
   * @param {number} code Error code
   * @param {string|number} id Error message ID
   * @throws Throws a JSON-RPC error object
   * @private
   */
  _raiseError(message, code, id) {
    const error = formatError({
      jsonrpc: this.version,
      delimiter: this.delimiter,
      id,
      code,
      message
    });
    throw new Error(error);
  }

  /**
   * Writes error to the client. Will send a JSON-RPC error object if the
   * passed error cannot be parsed.
   *
   * @param {string} error Stringified error object
   */
  handleError(error) {
    let err;
    try {
      err = JSON.stringify(JSON.parse(error.message));
    } catch (e) {
      err = formatError({
        jsonrpc: this.version,
        delimiter: this.delimiter,
        id: null,
        code: ERR_CODES.unknown,
        message: JSON.stringify(error, Object.getOwnPropertyNames(error))
      });
    }
    this.writeToClient(err + this.delimiter);
  }
}

module.exports = JsonRpcServerProtocol;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Mon Oct 12 2020 10:03:32 GMT-0400 (Eastern Daylight Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
