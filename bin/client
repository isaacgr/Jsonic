#!/usr/bin/env node

const package = require("../package.json");
const Jaysonic = require("..");
const program = require("commander");
const fs = require("fs");

program
  .version(package.version)
  .option(
    "--client-type <string>",
    "Type of client (tcp, ws, http)",
    "tcp",
    String
  )
  .requiredOption("--method <string>", "Method name for request", String)
  .option(
    "--params <object>",
    "Array or object to use as parameters",
    JSON.parse
  )
  .option("--host <string>", "Host IP of the server", "127.0.0.1", String)
  .option("--port <number>", "Port to connect to", Number)
  .option("--subscribe", "Subscribe to notifications for the given method")
  .option("--path <string>", "Path for ws or http client", "/", String)
  .option(
    "--delimiter <string>",
    "Delimiter to use for the request. Use $'\\n' for example as cli syntax for escape characters.",
    "\n"
  )
  .option("--timeout <number>", "Response timeout in seconds", 30, Number)
  .option(
    "--connection-timeout <number>",
    "Connection timeout in seconds",
    5,
    Number
  )
  .option(
    "--retries <number>",
    "Number of connection retry attempts",
    2,
    Number
  )
  .option("--jsonrpc-version <type>", "JSON-RPC version (1 or '2.0')", "2.0")
  .option("--write <string>", "Write output to file", String)
  .parse(process.argv);

const getClient = () => {
  const programOptions = {
    host: program.host,
    port: program.port,
    path: program.path,
    delimiter: program.delimiter,
    timeout: program.timeout,
    connectionTimeout: program.connectionTimeout,
    retries: program.retries,
    version: program.jsonrpcVersion
  };
  let client;
  if (program.clientType === "ws") {
    const options = {
      url: `ws://${program.host}:${program.port}${program.path}`
    };
    client = new Jaysonic.client.ws({
      ...programOptions,
      ...options
    });
  } else if (program.clientType === "http") {
    const options = {
      host: program.host,
      port: program.port,
      path: program.path
    };
    client = new Jaysonic.client.http({
      ...programOptions,
      ...options
    });
  } else if (program.clientType === "tcp") {
    const options = { host: program.host, port: program.port };
    client = new Jaysonic.client.tcp({
      ...programOptions,
      ...options
    });
  }
  return client;
};

const client = getClient();

if (!program.subscribe) {
  client
    .connect()
    .then(() => {
      client
        .request()
        .send(program.method, program.params)
        .then((result) => {
          if (program.write) {
            fs.writeFileSync(program.write, JSON.stringify(result));
          } else {
            console.log(result);
          }
          process.exit(0);
        })
        .catch((error) => {
          if (program.write) {
            fs.writeFileSync(program.write, JSON.stringify(error));
          } else {
            console.error(error);
          }
          process.exit(error.error.code);
        });
    })
    .catch((error) => {
      console.error(error);
      process.exit(error.error.code);
    });
} else {
  if (program.clientType === "http") {
    console.error("HTTP client does not support subscriptions");
    process.exit(-1);
  }
  client
    .connect()
    .then(() => {
      client.subscribe(program.method, (result) => {
        if (program.write) {
          fs.appendFileSync(program.write, JSON.stringify(result) + "\n");
        } else {
          console.log(result);
        }
      });
    })
    .catch((error) => {
      console.error(error);
      process.exit(error.error.code);
    });
}
