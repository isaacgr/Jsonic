<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>client/protocol/http.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="HttpClientFactory.html">HttpClientFactory</a><ul class='methods'><li data-type='method'><a href="HttpClientFactory.html#batch">batch</a></li><li data-type='method'><a href="HttpClientFactory.html#cleanUp">cleanUp</a></li><li data-type='method'><a href="HttpClientFactory.html#connect">connect</a></li><li data-type='method'><a href="HttpClientFactory.html#end">end</a></li><li data-type='method'><a href="HttpClientFactory.html#request">request</a></li><li data-type='method'><a href="HttpClientFactory.html#serverDisconnected">serverDisconnected</a></li><li data-type='method'><a href="HttpClientFactory.html#subscribe">subscribe</a></li><li data-type='method'><a href="HttpClientFactory.html#unsubscribe">unsubscribe</a></li><li data-type='method'><a href="HttpClientFactory.html#unsubscribeAll">unsubscribeAll</a></li></ul></li><li><a href="HttpClientProtocol.html">HttpClientProtocol</a><ul class='methods'><li data-type='method'><a href="HttpClientProtocol.html#batch">batch</a></li><li data-type='method'><a href="HttpClientProtocol.html#connect">connect</a></li><li data-type='method'><a href="HttpClientProtocol.html#end">end</a></li><li data-type='method'><a href="HttpClientProtocol.html#getBatchResponse">getBatchResponse</a></li><li data-type='method'><a href="HttpClientProtocol.html#getResponse">getResponse</a></li><li data-type='method'><a href="HttpClientProtocol.html#gotBatchResponse">gotBatchResponse</a></li><li data-type='method'><a href="HttpClientProtocol.html#handleBatch">handleBatch</a></li><li data-type='method'><a href="HttpClientProtocol.html#handleError">handleError</a></li><li data-type='method'><a href="HttpClientProtocol.html#handleNotification">handleNotification</a></li><li data-type='method'><a href="HttpClientProtocol.html#handleResponse">handleResponse</a></li><li data-type='method'><a href="HttpClientProtocol.html#listen">listen</a></li><li data-type='method'><a href="HttpClientProtocol.html#message">message</a></li><li data-type='method'><a href="HttpClientProtocol.html#notify">notify</a></li><li data-type='method'><a href="HttpClientProtocol.html#rejectPendingCalls">rejectPendingCalls</a></li><li data-type='method'><a href="HttpClientProtocol.html#request">request</a></li><li data-type='method'><a href="HttpClientProtocol.html#send">send</a></li><li data-type='method'><a href="HttpClientProtocol.html#setConnector">setConnector</a></li><li data-type='method'><a href="HttpClientProtocol.html#verifyData">verifyData</a></li><li data-type='method'><a href="HttpClientProtocol.html#write">write</a></li></ul></li><li><a href="HttpServerFactory.html">HttpServerFactory</a></li><li><a href="JsonRpcClientFactory.html">JsonRpcClientFactory</a><ul class='methods'><li data-type='method'><a href="JsonRpcClientFactory.html#batch">batch</a></li><li data-type='method'><a href="JsonRpcClientFactory.html#cleanUp">cleanUp</a></li><li data-type='method'><a href="JsonRpcClientFactory.html#connect">connect</a></li><li data-type='method'><a href="JsonRpcClientFactory.html#end">end</a></li><li data-type='method'><a href="JsonRpcClientFactory.html#request">request</a></li><li data-type='method'><a href="JsonRpcClientFactory.html#serverDisconnected">serverDisconnected</a></li><li data-type='method'><a href="JsonRpcClientFactory.html#subscribe">subscribe</a></li><li data-type='method'><a href="JsonRpcClientFactory.html#unsubscribe">unsubscribe</a></li><li data-type='method'><a href="JsonRpcClientFactory.html#unsubscribeAll">unsubscribeAll</a></li></ul></li><li><a href="JsonRpcClientProtocol.html">JsonRpcClientProtocol</a><ul class='methods'><li data-type='method'><a href="JsonRpcClientProtocol.html#batch">batch</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#connect">connect</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#end">end</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#getBatchResponse">getBatchResponse</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#getResponse">getResponse</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#gotBatchResponse">gotBatchResponse</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#handleBatch">handleBatch</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#handleError">handleError</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#handleNotification">handleNotification</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#handleResponse">handleResponse</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#listen">listen</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#message">message</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#notify">notify</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#rejectPendingCalls">rejectPendingCalls</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#request">request</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#send">send</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#setConnector">setConnector</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#verifyData">verifyData</a></li><li data-type='method'><a href="JsonRpcClientProtocol.html#write">write</a></li></ul></li><li><a href="JsonRpcServerFactory.html">JsonRpcServerFactory</a></li><li><a href="MessageBuffer.html">MessageBuffer</a><ul class='methods'><li data-type='method'><a href="MessageBuffer.html#getMessage">getMessage</a></li><li data-type='method'><a href="MessageBuffer.html#handleData">handleData</a></li><li data-type='method'><a href="MessageBuffer.html#isFinished">isFinished</a></li><li data-type='method'><a href="MessageBuffer.html#push">push</a></li></ul></li><li><a href="TcpClientFactory.html">TcpClientFactory</a><ul class='methods'><li data-type='method'><a href="TcpClientFactory.html#batch">batch</a></li><li data-type='method'><a href="TcpClientFactory.html#cleanUp">cleanUp</a></li><li data-type='method'><a href="TcpClientFactory.html#connect">connect</a></li><li data-type='method'><a href="TcpClientFactory.html#end">end</a></li><li data-type='method'><a href="TcpClientFactory.html#request">request</a></li><li data-type='method'><a href="TcpClientFactory.html#serverDisconnected">serverDisconnected</a></li><li data-type='method'><a href="TcpClientFactory.html#subscribe">subscribe</a></li><li data-type='method'><a href="TcpClientFactory.html#unsubscribe">unsubscribe</a></li><li data-type='method'><a href="TcpClientFactory.html#unsubscribeAll">unsubscribeAll</a></li></ul></li><li><a href="TcpClientProtocol.html">TcpClientProtocol</a><ul class='methods'><li data-type='method'><a href="TcpClientProtocol.html#batch">batch</a></li><li data-type='method'><a href="TcpClientProtocol.html#connect">connect</a></li><li data-type='method'><a href="TcpClientProtocol.html#end">end</a></li><li data-type='method'><a href="TcpClientProtocol.html#getBatchResponse">getBatchResponse</a></li><li data-type='method'><a href="TcpClientProtocol.html#getResponse">getResponse</a></li><li data-type='method'><a href="TcpClientProtocol.html#gotBatchResponse">gotBatchResponse</a></li><li data-type='method'><a href="TcpClientProtocol.html#handleBatch">handleBatch</a></li><li data-type='method'><a href="TcpClientProtocol.html#handleError">handleError</a></li><li data-type='method'><a href="TcpClientProtocol.html#handleNotification">handleNotification</a></li><li data-type='method'><a href="TcpClientProtocol.html#handleResponse">handleResponse</a></li><li data-type='method'><a href="TcpClientProtocol.html#listen">listen</a></li><li data-type='method'><a href="TcpClientProtocol.html#message">message</a></li><li data-type='method'><a href="TcpClientProtocol.html#notify">notify</a></li><li data-type='method'><a href="TcpClientProtocol.html#rejectPendingCalls">rejectPendingCalls</a></li><li data-type='method'><a href="TcpClientProtocol.html#request">request</a></li><li data-type='method'><a href="TcpClientProtocol.html#send">send</a></li><li data-type='method'><a href="TcpClientProtocol.html#setConnector">setConnector</a></li><li data-type='method'><a href="TcpClientProtocol.html#verifyData">verifyData</a></li><li data-type='method'><a href="TcpClientProtocol.html#write">write</a></li></ul></li><li><a href="WsBrowserClientFactory.html">WsBrowserClientFactory</a><ul class='methods'><li data-type='method'><a href="WsBrowserClientFactory.html#batch">batch</a></li><li data-type='method'><a href="WsBrowserClientFactory.html#cleanUp">cleanUp</a></li><li data-type='method'><a href="WsBrowserClientFactory.html#connect">connect</a></li><li data-type='method'><a href="WsBrowserClientFactory.html#end">end</a></li><li data-type='method'><a href="WsBrowserClientFactory.html#request">request</a></li><li data-type='method'><a href="WsBrowserClientFactory.html#subscribe">subscribe</a></li><li data-type='method'><a href="WsBrowserClientFactory.html#unsubscribe">unsubscribe</a></li><li data-type='method'><a href="WsBrowserClientFactory.html#unsubscribeAll">unsubscribeAll</a></li></ul></li><li><a href="WsBrowserClientProtocol.html">WsBrowserClientProtocol</a><ul class='methods'><li data-type='method'><a href="WsBrowserClientProtocol.html#batch">batch</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#getBatchResponse">getBatchResponse</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#getResponse">getResponse</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#gotBatchResponse">gotBatchResponse</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#handleBatch">handleBatch</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#handleError">handleError</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#handleNotification">handleNotification</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#handleResponse">handleResponse</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#message">message</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#notify">notify</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#rejectPendingCalls">rejectPendingCalls</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#request">request</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#send">send</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#setConnector">setConnector</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#verifyData">verifyData</a></li><li data-type='method'><a href="WsBrowserClientProtocol.html#write">write</a></li></ul></li><li><a href="WsClientFactory.html">WsClientFactory</a><ul class='methods'><li data-type='method'><a href="WsClientFactory.html#batch">batch</a></li><li data-type='method'><a href="WsClientFactory.html#cleanUp">cleanUp</a></li><li data-type='method'><a href="WsClientFactory.html#connect">connect</a></li><li data-type='method'><a href="WsClientFactory.html#end">end</a></li><li data-type='method'><a href="WsClientFactory.html#request">request</a></li><li data-type='method'><a href="WsClientFactory.html#serverDisconnected">serverDisconnected</a></li><li data-type='method'><a href="WsClientFactory.html#subscribe">subscribe</a></li><li data-type='method'><a href="WsClientFactory.html#unsubscribe">unsubscribe</a></li><li data-type='method'><a href="WsClientFactory.html#unsubscribeAll">unsubscribeAll</a></li></ul></li><li><a href="WsClientProtocol.html">WsClientProtocol</a><ul class='methods'><li data-type='method'><a href="WsClientProtocol.html#batch">batch</a></li><li data-type='method'><a href="WsClientProtocol.html#connect">connect</a></li><li data-type='method'><a href="WsClientProtocol.html#end">end</a></li><li data-type='method'><a href="WsClientProtocol.html#getBatchResponse">getBatchResponse</a></li><li data-type='method'><a href="WsClientProtocol.html#getResponse">getResponse</a></li><li data-type='method'><a href="WsClientProtocol.html#gotBatchResponse">gotBatchResponse</a></li><li data-type='method'><a href="WsClientProtocol.html#handleBatch">handleBatch</a></li><li data-type='method'><a href="WsClientProtocol.html#handleError">handleError</a></li><li data-type='method'><a href="WsClientProtocol.html#handleNotification">handleNotification</a></li><li data-type='method'><a href="WsClientProtocol.html#handleResponse">handleResponse</a></li><li data-type='method'><a href="WsClientProtocol.html#listen">listen</a></li><li data-type='method'><a href="WsClientProtocol.html#message">message</a></li><li data-type='method'><a href="WsClientProtocol.html#notify">notify</a></li><li data-type='method'><a href="WsClientProtocol.html#rejectPendingCalls">rejectPendingCalls</a></li><li data-type='method'><a href="WsClientProtocol.html#request">request</a></li><li data-type='method'><a href="WsClientProtocol.html#send">send</a></li><li data-type='method'><a href="WsClientProtocol.html#setConnector">setConnector</a></li><li data-type='method'><a href="WsClientProtocol.html#verifyData">verifyData</a></li><li data-type='method'><a href="WsClientProtocol.html#write">write</a></li></ul></li><li><a href="WSServer.html">WSServer</a><ul class='methods'><li data-type='method'><a href="WSServer.html#listen">listen</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="Jaysonic.html">Jaysonic</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">client/protocol/http.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const http = require("http");
const JsonRpcClientProtocol = require("./base");

/**
 * Creates an instance of HttpClientProtocol, which has some tweaks from the base class
 * required to work with the &lt;code>node.http&lt;/code> package
 *
 * @extends JsonRpcClientProtocol
 * @requires http
 */
class HttpClientProtocol extends JsonRpcClientProtocol {
  /** @inheritdoc */
  /**
   * @property {object} headers HTTP headers passed to the factory instance
   *
   * @property {string} encoding Encoding type passed to the factory instance
   */
  constructor(factory, version, delimiter) {
    super(factory, version, delimiter);

    this.headers = this.factory.headers;
    this.encoding = this.factory.encoding;
  }

  /**
   * Send a message to the server. Sets the request headers passed into &lt;code>headers&lt;/code>
   *
   * Calls [listen]{@link JsonRpcClientProtocol#listen} to start listening for recieved data from server.
   *
   * Ends connection when all data received from the server.
   *
   * Emits a `serverDisconnected` event when connection is closed.
   *
   * Throws an error if there was an &lt;code>error&lt;/code> event received when sending the request
   *
   * @param {string} request Stringified JSON-RPC message object
   * @param {function=} cb Callback function to be called when message has been sent
   */
  write(request, cb) {
    const options = {
      ...this.factory.options,
      ...this.headers
    };
    this.headers["Content-Length"] = Buffer.byteLength(request, this.encoding);
    this.connector = http.request(options, (response) => {
      if (cb) {
        response.on("end", cb);
      }
      this.listener = response;
      this.listen();
    });
    this.connector.write(request, this.encoding);
    this.connector.end();
    this.connector.on("close", () => {
      this.factory.emit("serverDisconnected");
    });
    this.connector.on("error", (error) => {
      throw error;
    });
  }

  /**
   * Send a notification to the server.
   *
   * Promise will resolve if the request was sucessfully sent, and reject if
   * there was an error sending the request. For the [HttpClientProtocol]{@link HttpClientProtocol}, the resolved promise
   * will return the http response object with a &lt;code>204&lt;/code> response code per the spec.
   *
   * @param {string} method Name of the method to use in the notification
   * @param {Array|JSON} params Params to send
   * @return Promise
   * @example
   *    client.notify("hello", ["world"])
   */
  notify(method, params) {
    return new Promise((resolve, reject) => {
      const request = this.message(method, params, false);
      try {
        this.write(request, () => {
          if (this.listener.statusCode === 204) {
            resolve(this.listener);
          } else {
            reject(new Error("no response receieved for notification"));
          }
        });
      } catch (e) {
        // this.connector is probably undefined
        reject(e);
      }
    });
  }

  /** @inheritdoc */
  getResponse(id) {
    return {
      body: this.responseQueue[id],
      ...this.writer
    };
  }

  /** @inheritdoc */
  getBatchResponse(batch) {
    return {
      body: batch,
      ...this.connector
    };
  }

  /** @inheritdoc */
  rejectPendingCalls(error) {
    const err = {
      body: error,
      ...this.connector
    };
    try {
      this.pendingCalls[err.body.id].reject(err);
      this.factory.cleanUp(err.body.id);
    } catch (e) {
      if (e instanceof TypeError) {
        // probably a parse error, which might not have an id
        console.error(
          `Message has no outstanding calls: ${JSON.stringify(err.body)}`
        );
      }
    }
  }
}

module.exports = HttpClientProtocol;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Mon Oct 12 2020 06:52:16 GMT-0400 (Eastern Daylight Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
